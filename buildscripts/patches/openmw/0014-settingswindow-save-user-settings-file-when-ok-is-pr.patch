From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Ilya Zhuravlev <whatever@xyz.is>
Date: Sun, 9 Jun 2019 11:32:56 -0400
Subject: [PATCH] settingswindow: save user settings file when "ok" is pressed

---
 apps/openmw/main.cpp                 | 3 +++
 apps/openmw/mwgui/settingswindow.cpp | 5 +++++
 2 files changed, 8 insertions(+)

diff --git a/apps/openmw/main.cpp b/apps/openmw/main.cpp
index a826b11b8..1df716fe6 100644
--- a/apps/openmw/main.cpp
+++ b/apps/openmw/main.cpp
@@ -207,6 +207,8 @@ namespace
     };
 }

+Files::ConfigurationManager *g_cfgMgr;
+
 int runApplication(int argc, char *argv[])
 {
     Platform::init();
@@ -219,6 +221,7 @@ int runApplication(int argc, char *argv[])

     osg::setNotifyHandler(new OSGLogHandler());
     Files::ConfigurationManager cfgMgr;
+       g_cfgMgr = &cfgMgr;
     std::unique_ptr<OMW::Engine> engine = std::make_unique<OMW::Engine>(cfgMgr);

     if (parseOptions(argc, argv, *engine, cfgMgr))
diff --git a/apps/openmw/mwgui/settingswindow.cpp b/apps/openmw/mwgui/settingswindow.cpp
index 2c6dd1369..e6542637c 100644
--- a/apps/openmw/mwgui/settingswindow.cpp
+++ b/apps/openmw/mwgui/settingswindow.cpp
@@ -29,6 +29,8 @@
 #include <components/lua_ui/scriptsettings.hpp>
 #include <components/vfs/manager.hpp>

+#include <components/files/configurationmanager.hpp>
+
 #include "../mwbase/environment.hpp"
 #include "../mwbase/world.hpp"
 #include "../mwbase/soundmanager.hpp"
@@ -151,6 +153,8 @@ namespace
     }
 }

+extern Files::ConfigurationManager *g_cfgMgr;
+
 namespace MWGui
 {
     void SettingsWindow::configureWidgets(MyGUI::Widget* widget, bool init)
@@ -420,6 +424,8 @@ namespace MWGui

     void SettingsWindow::onOkButtonClicked(MyGUI::Widget* _sender)
     {
+               const std::string settingspath = (g_cfgMgr->getUserConfigPath() / "settings.cfg").string();
+               Settings::Manager::saveUser(settingspath);
         MWBase::Environment::get().getWindowManager()->removeGuiMode(GM_Settings);
     }

